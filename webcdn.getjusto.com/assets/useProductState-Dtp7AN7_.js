import{f as D,z as q}from"./apollo-hooks.es-DZ97-Of4.js";import{r as g,g as T}from"./jsx-runtime-BGxL3LVy.js";import{p as R,q as B,c as E}from"./index-Dg1ijqza.js";import{s as F,u as k}from"./Context-BxTGfssI.js";import{a as A}from"./index-BHERncwe.js";import{b as W,a as L}from"./useWebsite-B2NA3eOh.js";import{g as S,a as y}from"./index-DUyAALTD.js";import{c as N,u as b,s as U}from"./index-CohxQZEM.js";import{_ as V,r as O}from"./_createAggregator-BbUU9R1n.js";import{m as j}from"./max-DoGq9HeY.js";import{v as z}from"./index-Dz7ujoPl.js";function $(e,t){return e.map((n,i)=>{const s=(n.options||[]).filter(c=>{var o,a,u;if(!((o=c.availabilityAt)!=null&&o.available))return!1;if((a=c==null?void 0:c.requiresModifierOptionIds)!=null&&a.length){for(const l of(c==null?void 0:c.requiresModifierOptionIds)||[])if(!!!((u=t.modifiers)!=null&&u.find(p=>{var m;return c.requiresAtLeastOneModifierOption?Q(p.optionsIds,c):(m=p.optionsIds)==null?void 0:m.includes(l)})))return!1}return!0});return{index:i,...n,options:s}}).filter(n=>{var i;return((i=n.options)==null?void 0:i.length)>0})}function Me(e,t){return g.useMemo(()=>$(e,t),[e,t])}const Q=(e,t)=>e.map(n=>t.requiresModifierOptionIds.includes(n)).includes(!0);function H(e,t){const{min:n,optional:i}=e;if(i&&t===0)return 0;const r=n-t;return r<0?0:r}function J(e,t){var n;if(t!=null&&t.length)for(const i of t){if(i.optional)continue;const r=e.modifiers.find(s=>s.modifierId===i._id);if(i.min&&r){if(H(i,r.optionsIds.length)>0)return i;continue}if(!((n=r==null?void 0:r.optionsIds)!=null&&n.length))return i}}function _(e,t,n=!0){if(!(e!=null&&e.availabilityAt))return;let i=n?e.availabilityAt.finalPrice:e.availabilityAt.basePrice;for(const{modifierId:r,optionsIds:s}of t.modifiers){const c=e.modifiers.find(o=>o._id===r);if(c)for(const o of s){const a=c.options.find(u=>u._id===o);a&&a.availabilityAt&&a.availabilityAt.price&&(i+=a.availabilityAt.price)}}return i}function w(e,t){const n=$(e.modifiers,t),i=J(t,n),r=t.amount,s=_(e,t,!0),c=_(e,t,!1);return{ready:!i,missingModifier:i,price:r*s,basePrice:r*c,amount:r,unitPrice:s,baseUnitPrice:c,maxPurchaseQuantity:e==null?void 0:e.maxPurchaseQuantity}}function Oe(e,t){return g.useMemo(()=>w(e,t),[e,t])}function h(e){var t,n,i;return!e||!((t=e.categories)!=null&&t.length)?1e4:((i=(n=e.categories)==null?void 0:n[0])==null?void 0:i.index)||0}const K=S(`mutation addProductToCart(
  $item: AddCartItemInput
  $websiteId: ID
  $sortScore: Float
) {
  updatedPreferences: addToCartPreferences(
    item: $item
    websiteId: $websiteId
    sortScore: $sortScore
  ) {
    ...OrderPreferencesFragment
  }
}`),G=S(`mutation updateCartItem(
  $cartItemId: ID
  $websiteId: ID
  $item: UpdateCartItemInput
) {
  updatedPreferences: updateCartItemPreferences(
    cartItemId: $cartItemId
    websiteId: $websiteId
    item: $item
  ) {
    ...OrderPreferencesFragment
  }
}`);function X(e){const t={productId:e.productId,comment:e.comment,modifiers:e.modifiers.map(c=>({modifierId:c.modifierId,optionsIds:c.optionsIds}))},n=F.sha256.create();n.update(JSON.stringify(t));const i=n.arrayBuffer();return btoa(String.fromCharCode(...new Uint8Array(i))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"").slice(0,32)}var Y=D,Z=V,x=Object.prototype,ee=x.hasOwnProperty,te=Z(function(e,t,n){ee.call(e,n)?++e[n]:Y(e,n,1)}),ie=te;const ne=T(ie);function re(e,t,n){var o;const i=(o=n==null?void 0:n.modifiers)==null?void 0:o.find(a=>a._id===e);if(!i)return[];const r=N(i.options,"_id"),s=ne(t),c=j(z(s))>1;return R(s).map(a=>{const u=r[a];return c?`${s[a]} ${u.name}`:u.name})}function oe(e){var n;const t=[];for(const i of e.modifiers||[])(n=i.optionsIds)!=null&&n.length&&t.push({title:se(i.modifierId,e.product),selections:re(i.modifierId,i.optionsIds,e.product)});return e.comment&&t.push({title:"Comentario",selections:[`"${e.comment}"`]}),t}function se(e,t){var i;const n=(i=t==null?void 0:t.modifiers)==null?void 0:i.find(r=>r._id===e);return n?n.shortName||n.name:"Modificador"}function v(e,t,n,i,r){return!n||!t.amount?null:{__typename:"OrderPreferencesCartItem",sortScore:i?h(i):null,_id:e,product:i,amount:t.amount,totalPrice:n.price,productId:t.productId,comment:t.comment,outOfStockMessage:(r==null?void 0:r.outOfStockMessage)||null,descriptionItems:i?oe({modifiers:t.modifiers,comment:t.comment,product:i}):null,isOutOfStock:(r==null?void 0:r.isOutOfStock)||!1,unitPrice:n.unitPrice,unitPriceWithoutDiscount:n.baseUnitPrice,modifiers:t.modifiers.map(s=>({__typename:"CartItemModifier",modifierId:s.modifierId,optionsIds:s.optionsIds}))}}function ae(){const e=W(),t=b(r=>{var s;return(s=r==null?void 0:r.menuData)==null?void 0:s.products}),n=y(r=>r.preferences),i=y(r=>r.cart);return g.useCallback((r,s,c)=>{var M;if(!i)return{};const o=r.cartItemId||X(r),a=U([...((i==null?void 0:i.items)||[]).map(d=>d._id===r.cartItemId?v(o,r,s,c,d):{sortScore:h(t[d.productId]),...d}).filter(Boolean),...r.cartItemId?[]:[v(o,r,s,c)]],"sortScore"),u=O(a.reduce((d,P)=>d+P.unitPriceWithoutDiscount*P.amount,0),e),l=O(a.reduce((d,P)=>d+P.totalPrice,0),e),I=(i==null?void 0:i.totalLoyaltyDiscount)||0,p=((M=i==null?void 0:i.couponStatus)==null?void 0:M.discountOnItems)||0,m=l-I-p,f=a.find(d=>d._id===o);return{updatedPreferences:{...n,cart:{...i,itemsPrice:m,itemsPriceWithoutDiscount:u,itemsPriceWithoutLoyaltyDiscount:m+I,itemsPriceWithOnlyItemsDiscount:l,items:a,__typename:"OrderPreferencesCart"}},itemId:o,cartItem:f}},[n,t])}const ce=(e,t)=>{if(t.cartItemId)return 0;const n=e.items.find(i=>i.productId===t.productId);return(n==null?void 0:n.amount)||0},ue=(e,t,n)=>{if(!n)return;const i=ce(t,e);if(e.amount+i>n){const r=`Puedes llevar hasta ${n} unidades de este producto`;throw A(r),new Error(r)}};function _e(){const e=q(),t=b(o=>o==null?void 0:o.menuId),n=L(),i=y(o=>o.cart),r=ae(),s=k(),c=b(o=>{var a;return((a=o==null?void 0:o.productsData)==null?void 0:a.productsMap)||{}});return g.useCallback(async(o,a)=>{if(!t)return;a||(a=c[o.productId]);const u=a?w(a,o):null;if(ue(o,i,u==null?void 0:u.maxPurchaseQuantity),u!=null&&u.missingModifier&&o.amount>0)throw B.fireEvent("addToCart.missingModifier",u.missingModifier),new Error("Falta un modificador");const l={item:{productId:o.productId,quantity:o.amount,modifiers:o.modifiers,comment:o.comment},websiteId:n,sortScore:a?h(a):null},I={cartItemId:o.cartItemId,item:{productId:o.productId,quantity:o.amount,modifiers:o.modifiers,comment:o.comment},websiteId:n},{updatedPreferences:p,cartItem:m}=r(o,u,a);try{if(o.amount>0)o.cartItemId?s.cartItemUpdated(m):s.productAddedToCart(m);else{const f=i.items.find(C=>C._id===I.cartItemId);f&&s.cartItemRemoved(f)}await e({clientName:E.preferences,mutation:o.cartItemId?G:K,variables:o.cartItemId?I:l,context:{queueKey:"updatePreferences"},optimisticResponse:{updatedPreferences:p}})}catch(f){throw console.error(f),A(f),f}},[t,r,i])}function de(e,t){var r;const n=(e==null?void 0:e.modifiers)||[];if(t)return{cartItemId:t._id,productId:e._id,comment:t.comment,amount:t.amount,modifiers:(r=t.modifiers)==null?void 0:r.map(s=>({modifierId:s.modifierId,optionsIds:s.optionsIds}))};const i=n.map(s=>({modifierId:s._id,optionsIds:[]}));return{productId:e._id,modifiers:i,comment:null,amount:1}}function ve(e,t){const[n,i]=g.useState(de(e,t));return{state:n,setState:i}}export{w as a,ve as b,Me as c,Oe as d,$ as e,de as g,_e as u};
